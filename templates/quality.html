{% extends "base_template.html" %}

{% block head %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="{{ url_for('static', filename='css/quality.css') }}" rel="stylesheet">
<script>
    // Prevent Bootstrap from modifying body styles
    document.addEventListener('DOMContentLoaded', function() {
        const originalSetAttribute = Element.prototype.setAttribute;
        Element.prototype.setAttribute = function(name, value) {
            if (this.tagName === 'BODY' && (name === 'style' || name === 'class')) {
                return;
            }
            originalSetAttribute.call(this, name, value);
        };
    });
</script>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <!-- Quality Check Form -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Quality Check Entry</h5>
                </div>
                <div class="card-body">
                    <form id="qualityForm" method="POST" action="{{ url_for('quality') }}">
                        <!-- Drawing Selection with Manual Entry -->
                        <div class="form-group mb-3">
                            <label for="drawing_number">Drawing Number</label>
                            <div class="input-group">
                                <select class="form-select" id="drawing_number" name="drawing_number" required>
                                    <option value="">Select Drawing</option>
                                    {% for drawing in active_drawings %}
                                    <option value="{{ drawing }}">{{ drawing }}</option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#manualDrawingModal">
                                    <i class="bi bi-pencil"></i> Manual Entry
                                </button>
                            </div>
                            <small class="text-muted">Select from list or enter manually</small>
                        </div>

                        <!-- Dynamic Content - Updated via AJAX -->
                        <div id="drawingDetails" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label>Batch Number</label>
                                        <input type="text" class="form-control" id="batch_id" name="batch_id">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label>Planned Quantity</label>
                                        <input type="number" class="form-control" id="planned_qty" name="planned_quantity" min="1" required>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group mb-3">
                                        <label>Completed</label>
                                        <input type="text" class="form-control" id="completed_qty" readonly>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group mb-3">
                                        <label>Rejected</label>
                                        <input type="text" class="form-control" id="rejected_qty" readonly>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group mb-3">
                                        <label>In Rework</label>
                                        <input type="text" class="form-control" id="rework_qty" readonly>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="check_type">Inspection Type</label>
                                        <select class="form-select" id="check_type" name="check_type" required>
                                            <option value="">Select Type</option>
                                            <option value="First Part">First Part Inspection (FPI)</option>
                                            <option value="In Process">In-Process Inspection</option>
                                            <option value="Last Part">Last Part Inspection (LPI)</option>
                                            <option value="Final">Final Inspection</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="quantity_checked">Quantity to Check</label>
                                        <input type="number" class="form-control" id="quantity_checked" name="quantity_checked" min="1" required>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="result">Result</label>
                                        <select class="form-select" id="result" name="result" required>
                                            <option value="">Select Result</option>
                                            <option value="Pass">Pass</option>
                                            <option value="Reject">Reject</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="inspector_id">Inspector ID</label>
                                        <input type="text" class="form-control" id="inspector_id" name="inspector_id" required>
                                    </div>
                                </div>
                            </div>

                            <div id="rejectionSection" style="display: none;">
                                <div class="form-group mb-3">
                                    <label for="rejection_reason">Rejection Reason</label>
                                    <textarea class="form-control" id="rejection_reason" name="rejection_reason" rows="2"></textarea>
                                </div>
                            </div>

                            <div class="form-group mb-3">
                                <label for="inspection_station">Inspection Station</label>
                                <input type="text" class="form-control" id="inspection_station" name="inspection_station" required>
                            </div>

                            <button type="submit" class="btn btn-primary">Submit Quality Check</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Rework Queue -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">Rework Queue</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Drawing</th>
                                    <th>Type</th>
                                    <th>Quantity</th>
                                    <th>Status</th>
                                    <th>Success Rate</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in rework_queue %}
                                <tr>
                                    <td>{{ item.drawing_number }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'warning' if item.type == 'First Part' 
                                                               else 'info' if item.type == 'In Process'
                                                               else 'primary' if item.type == 'Last Part'
                                                               else 'secondary' }}">
                                            {{ item.type }}
                                        </span>
                                    </td>
                                    <td>{{ item.remaining_quantity }}/{{ item.initial_quantity }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'primary' if item.status == 'In Progress' 
                                                               else 'warning' if item.status == 'Pending'
                                                               else 'success' }}">
                                            {{ item.status }}
                                        </span>
                                    </td>
                                    <td>
                                        {% set success_rate = item.rework_success_rate %}
                                        {% set bar_class = 'bg-success' if success_rate >= 80 else 'bg-warning' if success_rate >= 50 else 'bg-danger' %}
                                        <div class="progress">
                                            <div class="progress-bar {{ bar_class }}"
                                                 role="progressbar"
                                                 style="width: {{ success_rate }}%"
                                                 aria-valuenow="{{ success_rate }}"
                                                 aria-valuemin="0"
                                                 aria-valuemax="100">
                                                {{ "%.1f"|format(success_rate) }}%
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Recent Quality Checks -->
            <div class="card mt-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Recent Quality Checks</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Drawing</th>
                                    <th>Type</th>
                                    <th>Result</th>
                                    <th>Quantity</th>
                                    <th>Inspector</th>
                                    <th>Time</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for check in checks.items %}
                                <tr>
                                    <td>{{ check.drawing_number }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'warning' if check.type == 'First Part' 
                                                               else 'info' if check.type == 'In Process'
                                                               else 'primary' if check.type == 'Last Part'
                                                               else 'secondary' }}">
                                            {{ check.type }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if check.result == 'Pass' else 'danger' }}">
                                            {{ check.result }}
                                        </span>
                                    </td>
                                    <td>{{ check.quantity_checked }}</td>
                                    <td>{{ check.inspector_id }}</td>
                                    <td>{{ check.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Manual Drawing Number Entry Modal -->
<div class="modal" id="manualDrawingModal" tabindex="-1" role="dialog" aria-labelledby="manualDrawingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="manualDrawingModalLabel">Manual Drawing Entry</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="manualDrawingForm">
                    <div class="form-group mb-3">
                        <label for="manual_drawing_number" class="form-label">Drawing Number:</label>
                        <input type="text" class="form-control" id="manual_drawing_number" required>
                        <small class="text-muted">
                            Note: For drawings not in the dropdown list. Will be validated during submission.
                        </small>
                    </div>
                    <div class="form-group mb-3">
                        <label for="manual_batch_number" class="form-label">Batch Number:</label>
                        <input type="text" class="form-control" id="manual_batch_number" required>
                    </div>
                    <div class="form-group mb-3">
                        <label for="manual_planned_qty" class="form-label">Planned Quantity:</label>
                        <input type="number" class="form-control" id="manual_planned_qty" min="1" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmManualEntry">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Bootstrap CSS and JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const drawingSelect = document.getElementById('drawing_number');
    const drawingDetails = document.getElementById('drawingDetails');
    const resultSelect = document.getElementById('result');
    const rejectionSection = document.getElementById('rejectionSection');
    const quantityChecked = document.getElementById('quantity_checked');
    const modalElement = document.getElementById('manualDrawingModal');
    
    // Prevent modal from adding backdrop
    const manualDrawingModal = new bootstrap.Modal(modalElement, {
        backdrop: false,
        keyboard: false
    });
    
    // Custom modal open/close handling
    document.querySelector('[data-bs-toggle="modal"]').addEventListener('click', function(e) {
        e.preventDefault();
        document.body.style.overflow = 'auto';
        document.body.style.paddingRight = '0';
        manualDrawingModal.show();
    });
    
    modalElement.addEventListener('shown.bs.modal', function() {
        document.body.style.overflow = 'auto';
        document.body.style.paddingRight = '0';
        document.body.classList.remove('modal-open');
    });
    
    modalElement.addEventListener('hidden.bs.modal', function() {
        document.getElementById('manualDrawingForm').reset();
        document.body.style.overflow = 'auto';
        document.body.style.paddingRight = '0';
        document.body.classList.remove('modal-open');
        
        // Remove any backdrop that might have been added
        const backdrop = document.querySelector('.modal-backdrop');
        if (backdrop) {
            backdrop.remove();
        }
    });

    // Handle drawing selection
    drawingSelect.addEventListener('change', function() {
        if (this.value) {
            // Show the form details
            drawingDetails.style.display = 'block';
            
            // Fetch drawing details via AJAX
            fetch(`/api/drawing_details/${this.value}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        // If no production record found, clear fields but keep form visible
                        document.getElementById('batch_id').value = '';
                        document.getElementById('planned_qty').value = '';
                        document.getElementById('completed_qty').value = '0';
                        document.getElementById('rejected_qty').value = '0';
                        document.getElementById('rework_qty').value = '0';
                        quantityChecked.max = '';
                        quantityChecked.placeholder = 'Enter quantity';
                    } else {
                        document.getElementById('batch_id').value = data.batch_number;
                        document.getElementById('planned_qty').value = data.planned_quantity;
                        document.getElementById('completed_qty').value = data.completed_quantity;
                        document.getElementById('rejected_qty').value = data.rejected_quantity;
                        document.getElementById('rework_qty').value = data.rework_quantity;
                        
                        // Set max quantity that can be checked
                        const remainingQty = data.planned_quantity - data.completed_quantity - data.rejected_quantity;
                        quantityChecked.max = remainingQty;
                        quantityChecked.placeholder = `Max ${remainingQty} pieces`;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    drawingDetails.style.display = 'block';
                    // Clear fields but keep form visible for manual entry
                    document.getElementById('batch_id').value = '';
                    document.getElementById('planned_qty').value = '';
                    document.getElementById('completed_qty').value = '0';
                    document.getElementById('rejected_qty').value = '0';
                    document.getElementById('rework_qty').value = '0';
                });
        } else {
            drawingDetails.style.display = 'none';
        }
    });
    
    // Handle manual entry
    document.getElementById('confirmManualEntry').addEventListener('click', function() {
        const manualDrawing = document.getElementById('manual_drawing_number').value.trim();
        const manualBatch = document.getElementById('manual_batch_number').value.trim();
        const manualQty = document.getElementById('manual_planned_qty').value;
        
        if (manualDrawing && manualBatch && manualQty) {
            // Add to select if not exists
            let exists = false;
            for (let option of drawingSelect.options) {
                if (option.value === manualDrawing) {
                    exists = true;
                    break;
                }
            }
            if (!exists) {
                const newOption = new Option(manualDrawing, manualDrawing);
                drawingSelect.add(newOption);
            }
            
            // Select the drawing
            drawingSelect.value = manualDrawing;
            
            // Fill in the details
            drawingDetails.style.display = 'block';
            document.getElementById('batch_id').value = manualBatch;
            document.getElementById('planned_qty').value = manualQty;
            document.getElementById('completed_qty').value = '0';
            document.getElementById('rejected_qty').value = '0';
            document.getElementById('rework_qty').value = '0';
            
            // Set quantity checked max
            quantityChecked.max = manualQty;
            quantityChecked.placeholder = `Max ${manualQty} pieces`;
            
            manualDrawingModal.hide();
        }
    });
    
    // Handle result selection
    resultSelect.addEventListener('change', function() {
        rejectionSection.style.display = this.value === 'Reject' ? 'block' : 'none';
        
        if (this.value === 'Reject') {
            document.getElementById('rejection_reason').setAttribute('required', '');
        } else {
            document.getElementById('rejection_reason').removeAttribute('required');
        }
    });
    
    // Form validation
    document.getElementById('qualityForm').addEventListener('submit', function(e) {
        const qty = parseInt(quantityChecked.value);
        const max = parseInt(quantityChecked.max);
        
        if (max && qty > max) {
            e.preventDefault();
            alert(`Cannot check more than ${max} pieces`);
        }
    });
});
</script>
{% endblock %}
