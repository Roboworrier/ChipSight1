{% extends "base_template.html" %}

{% block content %}
<div class="container-fluid mt-4">
    <h2>Production Planner</h2>

    <!-- File Upload Section -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Upload Production Plan</h5>
        </div>
        <div class="card-body">
            <form method="POST" enctype="multipart/form-data" class="mb-3">
                <div class="mb-3">
                    <label for="file" class="form-label">Select Excel File (.xlsx)</label>
                    <input type="file" class="form-control" id="file" name="file" accept=".xlsx" required>
                    <div class="form-text">File should contain: project_code, project_name, end_product, sap_id, qty, completion_date, st, ct</div>
                </div>
                <button type="submit" class="btn btn-primary">Upload Plan</button>
            </form>
        </div>
    </div>

    <!-- Projects Table -->
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Current Projects</h5>
                <div class="d-flex gap-2">
                    <input type="text" id="projectSearch" class="form-control form-control-sm" placeholder="Search projects...">
                    <select id="statusFilter" class="form-select form-select-sm">
                        <option value="">All Status</option>
                        <option value="not_started">Not Started</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed">Completed</option>
                        <option value="delayed">Delayed</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="card-body">
            {% if projects %}
            <div class="table-responsive">
                <table class="table table-striped" id="projectsTable">
                    <thead>
                        <tr>
                            <th>Project Code</th>
                            <th>Project Name</th>
                            <th>End Product</th>
                            <th>SAP ID</th>
                            <th>Batch</th>
                            <th>Quantity (Plan/Actual)</th>
                            <th>Progress</th>
                            <th>Completion Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for project in projects %}
                        <tr data-status="{{ project.status }}">
                            <td>{{ project.code }}</td>
                            <td>{{ project.name }}</td>
                            <td>{{ project.end_product }}</td>
                            <td>{{ project.sap_id }}</td>
                            <td>{{ project.batch_number }}</td>
                            <td>
                                <span class="badge bg-primary">{{ project.planned_quantity }}</span>
                                <span class="text-muted">/</span>
                                <span class="badge bg-{{ 'success' if project.actual_quantity >= project.planned_quantity else 'warning' }}">
                                    {{ project.actual_quantity }}
                                </span>
                            </td>
                            <td>
                                <div class="progress">
                                    <div class="progress-bar bg-{{ project.progress_color }}"
                                         role="progressbar"
                                         style="width: {{ project.progress }}%; height: 20px"
                                         aria-valuenow="{{ project.progress }}"
                                         aria-valuemin="0"
                                         aria-valuemax="100">
                                        {{ "%.1f"|format(project.progress) }}%
                                    </div>
                                </div>
                            </td>
                            <td>{{ project.completion_date }}</td>
                            <td>
                                <span class="badge bg-{{ project.status_color }}">
                                    {{ project.status_text }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted mb-0">No projects uploaded yet. Use the form above to upload a production plan.</p>
            {% endif %}
        </div>
    </div>

    <!-- Historical Data -->
    <div class="card">
        <div class="card-header bg-info text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Historical Data</h5>
                <div class="d-flex gap-2">
                    <input type="text" id="historySearch" class="form-control form-control-sm" placeholder="Search history...">
                    <button class="btn btn-danger btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#quickDeleteSection">
                        <i class="bi bi-trash"></i> Quick Delete
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <!-- Quick Delete Section (Collapsible) -->
            <div class="collapse mb-4" id="quickDeleteSection">
                <div class="card card-body bg-light border-danger">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" id="quickDeleteInput" class="form-control" placeholder="Enter SAP ID or Project Code">
                                <button class="btn btn-danger" type="button" onclick="confirmQuickDelete()">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </div>
                            <small class="text-muted">For SAP ID with batch, use format: SAP001-1</small>
                        </div>
                    </div>
                </div>
            </div>

            {% if historical_data %}
            <div class="table-responsive">
                <table class="table table-sm" id="historyTable">
                    <thead>
                        <tr>
                            <th>SAP ID</th>
                            <th>Drawing Number</th>
                            <th>Last Run</th>
                            <th>Avg Setup Time</th>
                            <th>Avg Cycle Time</th>
                            <th>Total Quantity</th>
                            <th>Rework Rate</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in historical_data %}
                        <tr>
                            <td>{{ item.sap_id }}</td>
                            <td>{{ item.drawing_number }}</td>
                            <td>{{ item.last_run }}</td>
                            <td>{{ "%.2f"|format(item.avg_setup_time) }}</td>
                            <td>{{ "%.2f"|format(item.avg_cycle_time) }}</td>
                            <td>{{ item.total_quantity }}</td>
                            <td>
                                <span class="badge bg-{{ 'warning' if item.rework_rate > 5 else 'success' }}">
                                    {{ "%.1f"|format(item.rework_rate) }}%
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="showHistory('{{ item.sap_id }}')">
                                    View History
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted mb-0">No historical data available yet.</p>
            {% endif %}
        </div>
    </div>

    <!-- Deletion History -->
    <div class="card">
        <div class="card-header bg-danger text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Deletion History</h5>
                <input type="text" id="deletionSearch" class="form-control form-control-sm w-25" placeholder="Search deletions...">
            </div>
        </div>
        <div class="card-body">
            {% if deletion_history %}
            <div class="table-responsive">
                <table class="table table-sm" id="deletionTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Project Code</th>
                            <th>SAP ID</th>
                            <th>Batch</th>
                            <th>Quantities (Plan/Actual)</th>
                            <th>Reason</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in deletion_history %}
                        <tr>
                            <td>{{ item.deleted_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>
                                <span class="badge bg-{{ 'danger' if item.deletion_type == 'project' else 'warning' }}">
                                    {{ item.deletion_type|title }}
                                </span>
                            </td>
                            <td>{{ item.project_code }}</td>
                            <td>{{ item.sap_id }}</td>
                            <td>{{ item.batch_number }}</td>
                            <td>
                                <span class="badge bg-secondary">{{ item.planned_quantity }}/{{ item.actual_quantity }}</span>
                            </td>
                            <td>{{ item.reason or 'No reason provided' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p class="text-muted mb-0">No deletion history available.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- History Modal -->
<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Production History</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="historyModalContent">
                Loading...
            </div>
        </div>
    </div>
</div>

<!-- Delete End Product Modal -->
<div class="modal fade" id="deleteEndProductModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete End Product Batch</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this end product batch?</p>
                <form id="deleteEndProductForm">
                    <input type="hidden" id="deleteSapId" name="sap_id">
                    <input type="hidden" id="deleteBatchNumber" name="batch_number">
                    <div class="mb-3">
                        <label for="deleteEndProductReason" class="form-label">Reason for Deletion:</label>
                        <textarea class="form-control" id="deleteEndProductReason" name="reason" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="deleteEndProduct()">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Project Modal -->
<div class="modal fade" id="deleteProjectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete Entire Project</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="text-danger">Warning: This will delete all batches associated with this project!</p>
                <form id="deleteProjectForm">
                    <input type="hidden" id="deleteProjectCode" name="project_code">
                    <div class="mb-3">
                        <label for="deleteProjectReason" class="form-label">Reason for Deletion:</label>
                        <textarea class="form-control" id="deleteProjectReason" name="reason" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="deleteProject()">Delete Project</button>
            </div>
        </div>
    </div>
</div>

<!-- Quick Delete Modal -->
<div class="modal fade" id="quickDeleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="quickDeleteDetails" class="mb-3">
                    Loading details...
                </div>
                <form id="quickDeleteForm">
                    <input type="hidden" id="quickDeleteType" name="type">
                    <input type="hidden" id="quickDeleteValue" name="value">
                    <div class="mb-3">
                        <label for="quickDeleteReason" class="form-label">Reason for Deletion:</label>
                        <textarea class="form-control" id="quickDeleteReason" name="reason" rows="3" required></textarea>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="quickDeleteConfirm" required>
                        <label class="form-check-label" for="quickDeleteConfirm">
                            I understand this action cannot be undone
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="executeQuickDelete()">Delete</button>
            </div>
        </div>
    </div>
</div>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<script>
// Search functionality for projects
document.getElementById('projectSearch').addEventListener('keyup', function() {
    filterProjects();
});

document.getElementById('statusFilter').addEventListener('change', function() {
    filterProjects();
});

function filterProjects() {
    const searchText = document.getElementById('projectSearch').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const table = document.getElementById('projectsTable');
    const rows = table.getElementsByTagName('tr');

    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        const status = row.getAttribute('data-status');
        let show = true;

        // Check status filter
        if (statusFilter && status !== statusFilter) {
            show = false;
        }

        // Check search text
        if (show && searchText) {
            show = false;
            const cells = row.getElementsByTagName('td');
            for (let j = 0; j < cells.length; j++) {
                if (cells[j].textContent.toLowerCase().indexOf(searchText) > -1) {
                    show = true;
                    break;
                }
            }
        }

        row.style.display = show ? '' : 'none';
    }
}

// Search functionality for history
document.getElementById('historySearch').addEventListener('keyup', function() {
    const searchText = this.value.toLowerCase();
    const table = document.getElementById('historyTable');
    const rows = table.getElementsByTagName('tr');

    for (let i = 1; i < rows.length; i++) {
        let show = false;
        const cells = rows[i].getElementsByTagName('td');
        for (let j = 0; j < cells.length; j++) {
            if (cells[j].textContent.toLowerCase().indexOf(searchText) > -1) {
                show = true;
                break;
            }
        }
        rows[i].style.display = show ? '' : 'none';
    }
});

// View history details
function showHistory(sapId) {
    const modal = new bootstrap.Modal(document.getElementById('historyModal'));
    const content = document.getElementById('historyModalContent');
    
    // Fetch history data
    fetch(`/api/production_history/${sapId}`)
        .then(response => response.json())
        .then(data => {
            content.innerHTML = generateHistoryHTML(data);
        })
        .catch(error => {
            content.innerHTML = `<div class="alert alert-danger">Error loading history: ${error}</div>`;
        });
    
    modal.show();
}

function generateHistoryHTML(data) {
    return `
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Project</th>
                        <th>Quantity</th>
                        <th>Setup Time</th>
                        <th>Cycle Time</th>
                        <th>Quality</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.runs.map(run => `
                        <tr>
                            <td>${run.date}</td>
                            <td>${run.project_code}</td>
                            <td>${run.quantity}</td>
                            <td>${run.setup_time}</td>
                            <td>${run.cycle_time}</td>
                            <td>
                                <span class="badge bg-${run.quality_status === 'Pass' ? 'success' : 'warning'}">
                                    ${run.quality_status}
                                </span>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        </div>
        <div class="mt-3">
            <h6>Performance Trends</h6>
            <canvas id="historyChart"></canvas>
        </div>
    `;
}

// Delete end product functionality
function confirmDeleteEndProduct(sapId, batchNumber) {
    const modal = new bootstrap.Modal(document.getElementById('deleteEndProductModal'));
    document.getElementById('deleteSapId').value = sapId;
    document.getElementById('deleteBatchNumber').value = batchNumber;
    modal.show();
}

function deleteEndProduct() {
    const form = document.getElementById('deleteEndProductForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const formData = new FormData(form);
    fetch('/delete_end_product', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        window.location.reload();
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

// Delete project functionality
function confirmDeleteProject(projectCode) {
    const modal = new bootstrap.Modal(document.getElementById('deleteProjectModal'));
    document.getElementById('deleteProjectCode').value = projectCode;
    modal.show();
}

function deleteProject() {
    const projectCode = document.getElementById('deleteProjectCode').value;
    const reason = document.getElementById('deleteProjectReason').value;
    
    if (!reason) {
        alert('Please provide a reason for deletion');
        return;
    }

    const formData = new FormData();
    formData.append('reason', reason);

    fetch(`/delete_project/${encodeURIComponent(projectCode)}`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            throw new Error(data.error);
        }
        window.location.reload();
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}

// Search functionality for deletion history
document.getElementById('deletionSearch').addEventListener('keyup', function() {
    const searchText = this.value.toLowerCase();
    const table = document.getElementById('deletionTable');
    const rows = table.getElementsByTagName('tr');

    for (let i = 1; i < rows.length; i++) {
        let show = false;
        const cells = rows[i].getElementsByTagName('td');
        for (let j = 0; j < cells.length; j++) {
            if (cells[j].textContent.toLowerCase().indexOf(searchText) > -1) {
                show = true;
                break;
            }
        }
        rows[i].style.display = show ? '' : 'none';
    }
});

function confirmQuickDelete() {
    const input = document.getElementById('quickDeleteInput').value.trim();
    if (!input) {
        alert('Please enter a SAP ID or Project Code');
        return;
    }

    // First, fetch details about what will be deleted
    fetch(`/get_deletion_details/${encodeURIComponent(input)}`)
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }

            const detailsDiv = document.getElementById('quickDeleteDetails');
            document.getElementById('quickDeleteType').value = data.type;
            document.getElementById('quickDeleteValue').value = data.value;

            // Show what will be deleted
            let detailsHtml = '<div class="alert alert-warning">';
            detailsHtml += `<h6>The following will be deleted:</h6>`;
            if (data.type === 'project') {
                detailsHtml += `<p><strong>Project Code:</strong> ${data.value}<br>`;
                detailsHtml += `<strong>Project Name:</strong> ${data.details.name}<br>`;
                detailsHtml += `<strong>Total Batches:</strong> ${data.details.batch_count}</p>`;
            } else {
                detailsHtml += `<p><strong>SAP ID:</strong> ${data.value}<br>`;
                detailsHtml += `<strong>End Product:</strong> ${data.details.end_product}<br>`;
                detailsHtml += `<strong>Batch Number:</strong> ${data.details.batch_number}</p>`;
            }
            detailsHtml += '</div>';
            detailsDiv.innerHTML = detailsHtml;

            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('quickDeleteModal'));
            modal.show();
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
}

function executeQuickDelete() {
    const form = document.getElementById('quickDeleteForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    const type = document.getElementById('quickDeleteType').value;
    const value = document.getElementById('quickDeleteValue').value;
    const reason = document.getElementById('quickDeleteReason').value;
    
    if (!reason) {
        alert('Please provide a reason for deletion');
        return;
    }

    const formData = new FormData();
    formData.append('reason', reason);

    if (type === 'end_product') {
        // Parse SAP ID and batch number from the value (format: "SAP_ID-BATCH")
        const [sap_id, batch_number] = value.split('-');
        if (!sap_id || !batch_number) {
            alert('Invalid end product identifier');
            return;
        }
        formData.append('sap_id', sap_id);
        formData.append('batch_number', batch_number);
        
        fetch('/delete_end_product', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            window.location.reload();
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
    } else {
        // Project deletion
        fetch(`/delete_project/${encodeURIComponent(value)}`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            window.location.reload();
        })
        .catch(error => {
            alert('Error: ' + error.message);
        });
    }
}
</script>
{% endblock %} 